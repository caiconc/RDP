name: AnyDesk Only (No Tailscale)

on:
  workflow_dispatch:

jobs:
  anydesk-remote:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      # 1. CÀI MÀN HÌNH ẢO (BẮT BUỘC - Nếu không có cái này AnyDesk sẽ đen thui)
      - name: Install Virtual Display (Fix Black Screen)
        run: |
          $url = "https://www.amyuni.com/downloads/usbmmidd_v2.zip"
          $dest = "$env:TEMP\usbmmidd.zip"
          $extract = "C:\usbmmidd"
          
          Invoke-WebRequest -Uri $url -OutFile $dest
          Expand-Archive -Path $dest -DestinationPath $extract -Force
          
          # Tự tìm file exe
          $exePath = Get-ChildItem -Path $extract -Filter "deviceinstaller64.exe" -Recurse | Select-Object -First 1
          if ($exePath) {
            Set-Location -Path $exePath.DirectoryName
            & .\deviceinstaller64.exe install usbmmidd.inf usbmmidd
            & .\deviceinstaller64.exe enableidd 1
            Write-Host "Virtual Display OK."
          }

      # 2. CÀI ANYDESK & LẤY ID
      - name: Install & Config AnyDesk
        run: |
          # Tải về
          Invoke-WebRequest -Uri "https://download.anydesk.com/AnyDesk.exe" -OutFile "$env:TEMP\AnyDesk.exe"

          # Tạo mật khẩu mạnh (Bắt buộc phải có chữ hoa, thường, số, ký tự đặc biệt)
          $password = "GitHub@2025Actions!" 
          
          # Cài đặt
          & "$env:TEMP\AnyDesk.exe" --install "C:\Program Files (x86)\AnyDesk" --start-with-win --silent
          Start-Sleep -Seconds 10
          
          # Set mật khẩu (Dùng CMD để tránh lỗi PowerShell pipe)
          $anydesk = "C:\Program Files (x86)\AnyDesk\AnyDesk.exe"
          cmd.exe /c "echo $password | `"$anydesk`" --set-password"
          
          # Lấy ID (Thử lại vài lần nếu chưa kịp hiện)
          $id = ""
          for ($i=0; $i -lt 10; $i++) {
            $id = & $anydesk --get-id
            if ($id -match "\d+") { break }
            Start-Sleep -Seconds 3
          }
          
          echo "ANY_ID=$id" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "ANY_PWD=$password" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # 3. TỐI ƯU CPU CHO MƯỢT
      - name: Optimize Performance
        run: |
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\PriorityControl" /v Win32PrioritySeparation /t REG_DWORD /d 38 /f
          powercfg -setactive SCHEME_MIN

      # 4. HIỆN THÔNG TIN & GIỮ KẾT NỐI
      - name: Show Info
        run: |
          Write-Host "=================================="
          Write-Host " ANYDESK ID   : $env:ANY_ID"
          Write-Host " PASSWORD     : $env:ANY_PWD"
          Write-Host "=================================="
          
          # Vòng lặp giữ máy sống
          while ($true) {
            Start-Sleep -Seconds 180
            Test-Connection 8.8.8.8 -Count 1 -Quiet | Out-Null
          }
